import{_ as o,r as c,o as l,c as u,d as n,a as e,F as r,b as a,e as t}from"./app.0702af34.js";const p={},i=a('<h1 id="stale-closure-in-react-hooks" tabindex="-1"><a class="header-anchor" href="#stale-closure-in-react-hooks">\xB6</a> <span class="prefix"></span><span class="content" id="stale-closure-in-react-hooks"><a class="header-anchor" href="#stale-closure-in-react-hooks" aria-hidden="true">#</a> stale-closure-in-react-hooks</span><span class="suffix"></span></h1><p>\u7531\u4E8E\u95ED\u5305\u95EE\u9898\uFF0C\u5F00\u53D1\u8005\u5728\u67D0\u4E9B\u4F5C\u7528\u57DF\u4E2D\u5F97\u5230\u4E86\u8FC7\u65F6\u7684state\u3002</p>',2),k=n("details",null,[n("summary",null,"\u53C2\u8003"),n("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/QdByGrUzmY8?start=363",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""})],-1),d=n("p",null,"\u521B\u9020stale closure:",-1),m=n("div",{class:"language-javascript ext-js line-numbers-mode"},[n("pre",{class:"language-javascript"},[n("code",null,[n("span",{class:"token keyword"},"import"),t(" react"),n("span",{class:"token punctuation"},","),t(),n("span",{class:"token punctuation"},"{"),t(" useState"),n("span",{class:"token punctuation"},","),t(" useRef"),n("span",{class:"token punctuation"},","),t(" useEffect "),n("span",{class:"token punctuation"},"}"),t(),n("span",{class:"token keyword"},"from"),t(),n("span",{class:"token string"},'"react"'),n("span",{class:"token punctuation"},";"),t(`

`),n("span",{class:"token keyword"},"export"),t(),n("span",{class:"token keyword"},"default"),t(),n("span",{class:"token keyword"},"function"),t(),n("span",{class:"token function"},"StaleClosure"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token punctuation"},"{"),t(`

    `),n("span",{class:"token keyword"},"let"),t(),n("span",{class:"token punctuation"},"["),t("count"),n("span",{class:"token punctuation"},","),t(" setCount"),n("span",{class:"token punctuation"},"]"),t(),n("span",{class:"token operator"},"="),t(),n("span",{class:"token function"},"useState"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},")"),t(`
    `),n("span",{class:"token keyword"},"const"),t(" countRef "),n("span",{class:"token operator"},"="),t(),n("span",{class:"token function"},"useRef"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},")"),t(`

    console`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token template-string"},[n("span",{class:"token template-punctuation string"},"`"),n("span",{class:"token string"},"re-render?"),n("span",{class:"token template-punctuation string"},"`")]),n("span",{class:"token punctuation"},")"),t(`
    `),n("span",{class:"token function"},"useEffect"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token operator"},"=>"),t(),n("span",{class:"token punctuation"},"{"),t(`
        `),n("span",{class:"token keyword"},"const"),t(" intervalId "),n("span",{class:"token operator"},"="),t(),n("span",{class:"token function"},"setInterval"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token operator"},"=>"),t(),n("span",{class:"token punctuation"},"{"),t(`

            `),n("span",{class:"token comment"},"// console.log(`countRef.current`, countRef.current)"),t(`
            `),n("span",{class:"token function"},"setCount"),n("span",{class:"token punctuation"},"("),t("count "),n("span",{class:"token operator"},"+"),t(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),t(`
            `),n("span",{class:"token comment"},"// setCount(count++)"),t(`
            `),n("span",{class:"token comment"},"// setCount(state => state + 1)"),t(`
            
            `),n("span",{class:"token comment"},"// countRef.current = countRef.current + 1"),t(`
            `),n("span",{class:"token comment"},"// setCount(countRef.current)"),t(`
        `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},","),t(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},")"),t(`
        `),n("span",{class:"token keyword"},"return"),t(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token operator"},"=>"),t(),n("span",{class:"token function"},"clearInterval"),n("span",{class:"token punctuation"},"("),t("intervalId"),n("span",{class:"token punctuation"},")"),t(`
    `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},","),t(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),t(`
    `),n("span",{class:"token keyword"},"return"),t(),n("span",{class:"token operator"},"<"),t("span style"),n("span",{class:"token operator"},"="),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"{"),t(),n("span",{class:"token literal-property property"},"fontSize"),n("span",{class:"token operator"},":"),t(),n("span",{class:"token number"},"50"),t(),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},"{"),t("count"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token operator"},"<"),n("span",{class:"token operator"},"/"),t("span"),n("span",{class:"token operator"},">"),t(`
`),n("span",{class:"token punctuation"},"}"),t(`
`)]),n("div",{class:"m-mdic-copy-wrapper"},[n("div",{class:"u-mdic-copy-notify",id:"j-notify-1651016433290-1429"},"\u590D\u5236\u6210\u529F"),n("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":`import react, { useState, useRef, useEffect } from "react";

export default function StaleClosure() {

    let [count, setCount] = useState(null)
    const countRef = useRef(null)

    console.log(\`re-render?\`)
    useEffect(() => {
        const intervalId = setInterval(() => {

            // console.log(\`countRef.current\`, countRef.current)
            setCount(count + 1)
            // setCount(count++)
            // setCount(state => state + 1)
            
            // countRef.current = countRef.current + 1
            // setCount(countRef.current)
        }, 500)
        return () => clearInterval(intervalId)
    }, [])
    return <span style={{ fontSize: 50 }}>{count}</span>
}
`,"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1651016433290-1429","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"\u590D\u5236\u5931\u8D25",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"\u590D\u5236")])]),n("div",{class:"line-numbers"},[n("span",{class:"line-number"},"1"),n("br"),n("span",{class:"line-number"},"2"),n("br"),n("span",{class:"line-number"},"3"),n("br"),n("span",{class:"line-number"},"4"),n("br"),n("span",{class:"line-number"},"5"),n("br"),n("span",{class:"line-number"},"6"),n("br"),n("span",{class:"line-number"},"7"),n("br"),n("span",{class:"line-number"},"8"),n("br"),n("span",{class:"line-number"},"9"),n("br"),n("span",{class:"line-number"},"10"),n("br"),n("span",{class:"line-number"},"11"),n("br"),n("span",{class:"line-number"},"12"),n("br"),n("span",{class:"line-number"},"13"),n("br"),n("span",{class:"line-number"},"14"),n("br"),n("span",{class:"line-number"},"15"),n("br"),n("span",{class:"line-number"},"16"),n("br"),n("span",{class:"line-number"},"17"),n("br"),n("span",{class:"line-number"},"18"),n("br"),n("span",{class:"line-number"},"19"),n("br"),n("span",{class:"line-number"},"20"),n("br"),n("span",{class:"line-number"},"21"),n("br"),n("span",{class:"line-number"},"22"),n("br"),n("span",{class:"line-number"},"23"),n("br")])],-1),b=a("<ul><li>setInterval\u7684\u4F20\u53C2\u51FD\u6570\u4E2D\uFF0C\u7531\u4E8E\u4F7F\u7528\u4E86<code>StaleClosure</code>\u51FD\u6570\u4F5C\u7528\u57DF\u7684count\u53D8\u91CF\uFF0C\u5F62\u6210\u95ED\u5305\uFF0C\u800C\u4E14\u662F <strong>stale closure</strong>\u3002 <ul><li>setCount\u8C03\u7528\u65F6\uFF0C\u5982\u679C\u662Fcount+1\u8FD9\u6837\u7684\u4E00\u4E2A\u503C\uFF0C\u76F8\u5F53\u4E8E\u6BCF\u4E2Atick\u90FD\u662F\u8C03\u7528setCount(1)</li><li>\u6B64\u65F6\uFF0C\u7EC4\u4EF6<code>StaleClosure</code>\u4E0D\u4F1Are-render\u3002</li></ul></li><li>\u4E0D\u8FC7\u4EE3\u7801\u4E2D\u6CE8\u91CA\u7684\u4E09\u79CD\u5199\u6CD5\u662F\u53EF\u4EE5\u8BA9\u7EC4\u4EF6\u5728\u6BCF\u4E2Atick\u4E2Dre-render\u7684\u3002\u4E3B\u8981\u662F\u4E24\u79CD\u601D\u8DEF <ul><li>\u7528\u65B9\u6CD5\u7684\u65F6\u5019\uFF0C\u4F20\u5165\u4E00\u4E2A\u51FD\u6570</li><li>\u7528useRef.current\u6682\u5B58\u3002</li></ul></li><li>\u4E5F\u662F\u7531\u4E8E\u8FD9\u4E2A\u95ED\u5305<code>stale closure</code>\u7684\u5B58\u5728\uFF0C\u60F3\u8981\u5728setInterval\u7684\u4F20\u53C2\u51FD\u6570\u52A0\u5165\u62E6\u622A\u7684\u65F6\u5019\uFF0C\u8BBF\u95EEcount\u53D8\u91CF\u4E0D\u662F\u4E00\u4E2A\u597D\u64CD\u4F5C\u3002</li></ul>",1),f=n("div",{class:"language-javascript ext-js line-numbers-mode"},[n("pre",{class:"language-javascript"},[n("code",null,[n("span",{class:"token function"},"useEffect"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token operator"},"=>"),t(),n("span",{class:"token punctuation"},"{"),t(`
    `),n("span",{class:"token keyword"},"const"),t(" intervalId "),n("span",{class:"token operator"},"="),t(),n("span",{class:"token function"},"setInterval"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token operator"},"=>"),t(),n("span",{class:"token punctuation"},"{"),t(`

        `),n("span",{class:"token comment"},"// if (count >= 10) return  //\u65E0\u6CD5\u62E6\u622A,count\u6C38\u8FDC\u662F\u521D\u59CB\u503C"),t(`
        `),n("span",{class:"token keyword"},"if"),t(),n("span",{class:"token punctuation"},"("),t("countRef"),n("span",{class:"token punctuation"},"."),t("current "),n("span",{class:"token operator"},">="),t(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token keyword"},"return"),t("   "),n("span",{class:"token comment"},"//\u53EF\u4EE5\u62E6\u622A"),t(`
        console`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token template-string"},[n("span",{class:"token template-punctuation string"},"`"),n("span",{class:"token string"},"comparison"),n("span",{class:"token template-punctuation string"},"`")]),n("span",{class:"token punctuation"},","),t(" count"),n("span",{class:"token punctuation"},","),t(" countRef"),n("span",{class:"token punctuation"},"."),t("current"),n("span",{class:"token punctuation"},")"),t(`
        `),n("span",{class:"token comment"},"// setCount(count + 1)"),t(`
        `),n("span",{class:"token comment"},"// setCount(count++)"),t(`
        `),n("span",{class:"token function"},"setCount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token parameter"},"state"),t(),n("span",{class:"token operator"},"=>"),t(" state "),n("span",{class:"token operator"},"+"),t(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),t(`
        countRef`),n("span",{class:"token punctuation"},"."),t("current "),n("span",{class:"token operator"},"="),t(" countRef"),n("span",{class:"token punctuation"},"."),t("current "),n("span",{class:"token operator"},"+"),t(),n("span",{class:"token number"},"1"),t(`
        `),n("span",{class:"token comment"},"// setCount(countRef.current)"),t(`
    `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},","),t(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},")"),t(`
    `),n("span",{class:"token keyword"},"return"),t(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),t(),n("span",{class:"token operator"},"=>"),t(),n("span",{class:"token function"},"clearInterval"),n("span",{class:"token punctuation"},"("),t("intervalId"),n("span",{class:"token punctuation"},")"),t(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},","),t(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),t(`
`)]),n("div",{class:"m-mdic-copy-wrapper"},[n("div",{class:"u-mdic-copy-notify",id:"j-notify-1651016433291-42210"},"\u590D\u5236\u6210\u529F"),n("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":`useEffect(() => {
    const intervalId = setInterval(() => {

        // if (count >= 10) return  //\u65E0\u6CD5\u62E6\u622A,count\u6C38\u8FDC\u662F\u521D\u59CB\u503C
        if (countRef.current >= 10) return   //\u53EF\u4EE5\u62E6\u622A
        console.log(\`comparison\`, count, countRef.current)
        // setCount(count + 1)
        // setCount(count++)
        setCount(state => state + 1)
        countRef.current = countRef.current + 1
        // setCount(countRef.current)
    }, 500)
    return () => clearInterval(intervalId)
}, [])
`,"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1651016433291-42210","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"\u590D\u5236\u5931\u8D25",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"\u590D\u5236")])]),n("div",{class:"line-numbers"},[n("span",{class:"line-number"},"1"),n("br"),n("span",{class:"line-number"},"2"),n("br"),n("span",{class:"line-number"},"3"),n("br"),n("span",{class:"line-number"},"4"),n("br"),n("span",{class:"line-number"},"5"),n("br"),n("span",{class:"line-number"},"6"),n("br"),n("span",{class:"line-number"},"7"),n("br"),n("span",{class:"line-number"},"8"),n("br"),n("span",{class:"line-number"},"9"),n("br"),n("span",{class:"line-number"},"10"),n("br"),n("span",{class:"line-number"},"11"),n("br"),n("span",{class:"line-number"},"12"),n("br"),n("span",{class:"line-number"},"13"),n("br"),n("span",{class:"line-number"},"14"),n("br")])],-1),y=a('<h2 id="\u5F85\u5B9A" tabindex="-1"><a class="header-anchor" href="#\u5F85\u5B9A">\xB6</a> <span class="prefix"></span><span class="content" id="\u5F85\u5B9A"><a class="header-anchor" href="#\u5F85\u5B9A" aria-hidden="true">#</a> \u5F85\u5B9A</span><span class="suffix"></span></h2>',1),h={href:"https://overreacted.io/zh-hans/making-setinterval-declarative-with-react-hooks/",target:"_blank",rel:"noopener noreferrer"},C=t("\u4E5F\u662F\u7814\u7A76\u8FD9\u4E2A\u95ED\u5305\u95EE\u9898"),v={href:"https://zh-hans.reactjs.org/docs/hooks-rules.html",target:"_blank",rel:"noopener noreferrer"},_=t("React\u6587\u6863-Hook \u89C4\u5219"),g={href:"https://dmitripavlutin.com/react-hooks-stale-closures/",target:"_blank",rel:"noopener noreferrer"},w=t("Be Aware of Stale Closures when Using React Hooks");function R(I,x){const s=c("ExternalLinkIcon");return l(),u(r,null,[i,k,d,m,b,f,y,n("ul",null,[n("li",null,[n("a",h,[C,e(s)])]),n("li",null,[n("a",v,[_,e(s)])]),n("li",null,[n("a",g,[w,e(s)])])])],64)}var E=o(p,[["render",R]]);export{E as default};
